{% extends "admin_layout.html" %}

{% block title %}Manage Destinations{% endblock %}

{% block content %}
<h2>Manage Destinations <button onclick="openAddModal()" class="add-btn">Add Destination</button></h2>

<table>
  <thead>
    <tr>
      <th>Kerala District</th>
      <th>Place</th>
      <th>Type</th>
      <th>Description</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="destinations-table-body">
    {% for dest in destinations %}
    <!-- CORRECTION 1: Used the |tojson filter to safely embed data into attributes. -->
    <!-- This prevents JavaScript errors if your data contains quotes or other special characters. -->
    <tr id="dest-row-{{ dest.Destination_id }}"
        data-id="{{ dest.Destination_id }}"
        data-name={{ dest.Name | tojson }}
        data-place={{ dest.Place | tojson }}
        data-type={{ dest.Type | tojson }}
        data-description={{ dest.Description | tojson }}>
      <td>{{ dest.Name }}</td>
      <td>{{ dest.Place }}</td>
      <td>{{ dest.Type }}</td>
      <td>{{ dest.Description }}</td>
      <td>
        <button onclick="openEditModal({{ dest.Destination_id }})" class="btn btn-secondary">Edit</button>
        <form style="display: inline" method="POST" action="{{ url_for('delete_destination', dest_id=dest.Destination_id) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- The multipurpose Modal for adding and editing -->
<div id="destinationModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">Add New Destination</h2>
    <form id="destinationForm" onsubmit="saveDestination(event)">
      <input type="hidden" id="destId" name="destId">
      
      <div class="form-group"><label for="name">Kerala District</label><input type="text" id="name" name="name" required></div>
      <div class="form-group"><label for="place">Place</label><input type="text" id="place" name="place" required></div>
      <div class="form-group">
        <label for="type">Type</label>
        <select id="type" name="type" required>
          <option value="" disabled selected>Select type</option>
          <option value="beach">Beach</option>
          <option value="hill">Hill</option>
          <option value="wildlife">Wildlife</option>
        </select>
      </div>
      <div class="form-group"><label for="description">Description</label><textarea id="description" name="description" rows="4" required></textarea></div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Destination</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const modal = document.getElementById('destinationModal');
const modalTitle = document.getElementById('modalTitle');
const form = document.getElementById('destinationForm');
const destIdField = document.getElementById('destId');

// --- Modal Controls ---
function openModal() {
  modal.style.display = 'flex';
}

function closeModal() {
  modal.style.display = 'none';
}

// --- Functions to set up the modal for ADD or EDIT ---
function openAddModal() {
  form.reset();
  destIdField.value = '';
  modalTitle.innerText = 'Add New Destination';
  openModal();
}

function openEditModal(destId) {
  const row = document.getElementById(`dest-row-${destId}`);
  
  // Get data from the data-* attributes
  const name = row.dataset.name;
  const place = row.dataset.place;
  const type = row.dataset.type;
  const description = row.dataset.description;

  // Populate the form fields
  form.name.value = name;
  form.place.value = place;
  form.type.value = type;
  form.description.value = description;
  destIdField.value = destId;

  modalTitle.innerText = 'Edit Destination';
  openModal();
}

// Close modal if user clicks outside of the modal content
window.onclick = function(event) {
  if (event.target == modal) {
    closeModal();
  }
}

// CORRECTION 2: The `saveDestination` function is now fully corrected.
function saveDestination(event) {
  event.preventDefault();
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  const destId = destIdField.value;

  let url = '/admin/add-destination';
  let method = 'POST'; // Default method for creating a new item

  // If there's an ID, we're updating, so change the URL AND the method
  if (destId) {
    url = `/admin/update-destination/${destId}`;
    method = 'PUT'; // This is the CRITICAL FIX for the edit functionality
  }

  fetch(url, {
    method: method, // The method is now dynamic (POST or PUT)
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => {
    // Improved error handling: Check if the server response is OK
    if (!response.ok) {
        // If not, throw an error to be caught by the .catch block
        throw new Error(`Server responded with status: ${response.status}`);
    }
    // Only if the response is OK, we try to parse it as JSON
    return response.json();
  })
  .then(result => {
    if (result.success) {
      window.location.reload(); // Reload to see changes
    } else {
      alert(result.message || 'Failed to save destination.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // This will now show a much more useful error message!
    alert('An error occurred: ' + error.message);
  });
  return false;
}
</script>
{% endblock %}