{% extends "admin_layout.html" %}

{% block title %}Manage Destinations{% endblock %}

{% block content %}
<h2>Manage Destinations <button onclick="openAddModal()" class="add-btn">Add Destination</button></h2>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Place</th>
      <th>Type</th>
      <th>Description</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="destinations-table-body">
    {% for dest in destinations %}
    <tr id="dest-row-{{ dest.Destination_id }}">
      <td>{{ dest.Name }}</td>
      <td>{{ dest.Place }}</td>
      <td>{{ dest.Type }}</td>
      <td>{{ dest.Description }}</td>
      <td>
        <a href="{{ url_for('edit_destination', dest_id=dest.Destination_id) }}" class="btn btn-secondary">Edit</a>
        <form style="display: inline" method="POST" action="{{ url_for('delete_destination', dest_id=dest.Destination_id) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add Destination Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h2>Add New Destination</h2>
    <form id="addForm" onsubmit="return saveDestination(event)">
      <div class="form-group"><label for="name">Name</label><input type="text" id="name" name="name" required></div>
      <div class="form-group"><label for="place">Place</label><input type="text" id="place" name="place" required></div>
      <div class="form-group">
        <label for="type">Type</label>
        <select id="type" name="type" required>
          <option value="" disabled selected>Select type</option>
          <option value="beach">Beach</option>
          <option value="hill">Hill</option>
          <option value="wildlife">Wildlife</option>
        </select>
      </div>
      <div class="form-group"><label for="description">Description</label><textarea id="description" name="description" rows="4" required></textarea></div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Destination</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// This script is specific to this page for handling the modal.
function openAddModal() {
  const modal = document.getElementById('addModal');
  modal.style.display = 'flex';
  document.getElementById('addForm').reset();
}

function closeModal() {
  document.getElementById('addModal').style.display = 'none';
}

// Close modal if user clicks outside of the modal content
window.onclick = function(event) {
  const modal = document.getElementById('addModal');
  if (event.target == modal) {
    closeModal();
  }
}

function saveDestination(event) {
  event.preventDefault();
  const form = document.getElementById('addForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  fetch('/admin/add-destination', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
        return response.json().then(err => { throw new Error(err.message || 'Server error') });
    }
    return response.json();
  })
  .then(result => {
    if (result.success) {
      // Instead of manually adding a row, we just reload the page to see the new data.
      // This is simpler in a server-side rendered approach.
      window.location.reload();
    } else {
      alert(result.message || 'Failed to save destination.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred: ' + error.message);
  });
  return false;
}
</script>
{% endblock %}