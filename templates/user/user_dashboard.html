<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Travel Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- ### START: LEAFLET.JS STYLESHEETS ### -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <!-- ### END: LEAFLET.JS STYLESHEETS ### -->

    <style>
        :root {
            --sidebar-width: 240px; /* Increased width slightly for better text fit */
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --white: #fff;
            --border-color: #e9ecef;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            display: flex;
            min-height: 100vh;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        /* ### START: SIDEBAR STYLES ### */
        .sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--white); 
            box-shadow: var(--shadow); 
            padding: 20px 0; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            justify-content: space-between; /* MODIFIED: Pushes footer to the bottom */
        }
        
        .sidebar-header { 
            color: var(--primary-color); 
            font-size: 1.6rem; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 0 20px; 
        }

        .sidebar-nav ul { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }

        .sidebar-nav li { 
            margin-bottom: 5px; 
        }

        .sidebar-nav a { 
            display: flex; 
            align-items: center; 
            padding: 12px 25px; 
            color: var(--dark-text); 
            text-decoration: none; 
            font-weight: 500; 
            transition: background-color 0.2s ease, color 0.2s ease; 
            border-left: 4px solid transparent; 
        }

        .sidebar-nav a:hover {
            background-color: #eef5ff;
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }
        
        .sidebar-nav a.active { 
            background-color: #eef5ff; 
            color: var(--primary-color); 
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar-nav a i { 
            margin-right: 15px; 
            width: 20px;
            text-align: center;
        }
        /* ### END: SIDEBAR STYLES ### */
        
        /* ### START: LOGOUT STYLES ### */
        .sidebar-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
        }

        .logout-link {
            display: flex;
            align-items: center;
            color: var(--primary-color); /* MODIFIED: Changed from --danger-color to --primary-color */
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .logout-link:hover {
            color: #0056b3; /* MODIFIED: Darker blue for hover effect */
        }

        .logout-link i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        /* ### END: LOGOUT STYLES ### */

        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .header-card { background-image: url("{{ url_for('static', filename='Images/image.png') }}"); background-size: cover; background-position: center; border-radius: 12px; padding: 40px; color: var(--white); text-align: center; margin-bottom: 40px; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .header-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)); z-index: 1; }
        .header-card-content { position: relative; z-index: 2; }
        .header-card h2 { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; }
        .header-card p { font-size: 1.1rem; line-height: 1.6; max-width: 600px; margin: 0 auto; }
        .plan-trip-section { background-color: var(--white); border-radius: 12px; padding: 30px; margin-bottom: 40px; box-shadow: var(--shadow); }
        .plan-trip-section h3 { font-size: 1.8rem; font-weight: 600; margin-bottom: 25px; color: var(--dark-text); }
        .form-row { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .form-group { flex: 1; display: flex; flex-direction: column; min-width: 200px;}
        .form-group label { font-weight: 500; margin-bottom: 8px; color: var(--secondary-color); }
        .form-group select { width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--light-bg); appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 1.2em; }
        .btn-primary { background-color: var(--primary-color); color: var(--white); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s ease; white-space: nowrap; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .route-layout {
            display: flex;
            gap: 30px;
            flex-wrap: wrap; 
        }

        #map {
            height: 500px;
            flex: 1; 
            min-width: 300px; 
            border-radius: 8px;
            border: 1px solid var(--border-color);
            z-index: 1;
        }

        #route-details {
            flex: 1;
            min-width: 300px;
        }

        .leaflet-routing-container { 
            display: none !important; 
        }
        
        .suggested-destinations { margin-top: 40px; }
        .suggested-destinations h3 { font-size: 1.8rem; font-weight: 600; margin-bottom: 25px; color: var(--dark-text); }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-right: 10px; }
        .status-badge.safe, .status-badge.status-safe { background-color: var(--success-color); color: var(--white); }
        .status-badge.caution { background-color: var(--warning-color); color: var(--dark-text); }
        .status-badge.unsafe { background-color: var(--danger-color); color: var(--white); }
        .generated-route-section { background-color: var(--white); border-radius: 12px; padding: 30px; margin-bottom: 40px; box-shadow: var(--shadow); display: none; }
        .generated-route-section.active { display: block; }
        .route-header { display: flex; align-items: center; margin-bottom: 25px; color: var(--success-color); font-size: 1.5rem; font-weight: 600; }
        .route-header i { margin-right: 10px; }
        .route-card { background-color: var(--light-bg); border-radius: 10px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        .route-card h4 { font-size: 1.2rem; font-weight: 600; margin-top: 0; margin-bottom: 15px; color: var(--dark-text); }
        .route-summary-details p { margin: 5px 0; font-size: 0.95rem; }
        .route-summary-details strong { color: var(--dark-text); }
        .weather-alert-card { background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin-bottom: 15px; display: flex; align-items: flex-start; }
        .weather-alert-card i { color: #ffc107; font-size: 1.5rem; margin-right: 15px; }
        .weather-alert-card h5 { font-size: 1.1rem; font-weight: 600; margin-top: 0; margin-bottom: 5px; color: #856404; }
        .weather-alert-card p, .weather-alert-card span { font-size: 0.9rem; color: #856404; margin-bottom: 5px; }
        .tip-card { background-color: #d4edda; border-left: 5px solid #28a745; border-radius: 8px; padding: 15px 20px; display: flex; align-items: flex-start; margin-top: 25px; }
        .tip-card i { color: #28a745; font-size: 1.5rem; margin-right: 15px; }
        .tip-card p { font-size: 0.95rem; color: #155724; margin: 0; }
        .stop-card { flex: 1; min-width: 250px; background-color: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #e9ecef; display: flex; flex-direction: column; justify-content: space-between; }
        .stop-card h5 { font-size: 1.1rem; font-weight: 600; margin-top: 0; margin-bottom: 5px; color: var(--dark-text); }
        .stop-card p { font-size: 0.9rem; margin-bottom: 5px; }
        .stop-card .status-badge { margin-top: 10px; margin-right: 0; }
        .recommended-stops { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div>
            <div class="sidebar-header">
                Safe Route
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" class="active"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#"><i class="fas fa-search"></i> Search Destination</a></li>
                    <li><a href="#"><i class="fas fa-history"></i> Previous Routes</a></li>
                    <li><a href="#"><i class="fas fa-heart"></i> Favorite</a></li>
                </ul>
            </nav>
        </div>

        <div class="sidebar-footer">
            <a href="{{ url_for('auth.logout') }}" class="logout-link">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="header-card">
            <div class="header-card-content">
                <h2>Plan Your Perfect Trip</h2>
                <p>Enter your details below to generate a safe and scenic route for your next adventure in Kerala.</p>
            </div>
        </div>

        <div class="plan-trip-section">
            <h3>Plan Your Safe Trip</h3>
            <form id="planTripForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceDistrict">Source District:</label>
                        <select id="sourceDistrict" name="sourceDistrict" required>
                            <option value="">Choose...</option>
                            {% for district in districts %}<option value="{{ district }}">{{ district }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="destinationDistrict">Destination District:</label>
                        <select id="destinationDistrict" name="destinationDistrict" required>
                            <option value="">Choose...</option>
                            {% for district in districts %}<option value="{{ district }}">{{ district }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="interest">Interest:</label>
                        <select id="interest" name="interest" required>
                            <option value="">Choose...</option>
                            {% for interest in interests %}
                            <option value="{{ interest }}">{{ interest | capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="budget">Budget (₹):</label>
                        <select id="budget" name="budget" required>
                            <option value="">Choose...</option>
                            <option value="5000">₹5,000</option>
                            <option value="10000">₹10,000</option>
                            <option value="15000">₹15,000</option>
                            <option value="20000">₹20,000+</option>
                        </select>
                    </div>
                     <button type="submit" class="btn-primary" id="generateBtn">
                        <span id="btn-text">Generate Safe Route</span>
                        <span id="btn-spinner" style="display:none;"><i class="fas fa-spinner fa-spin"></i> Generating...</span>
                    </button>
                </div>
            </form>
        </div>

        <div id="generatedRouteSection" class="generated-route-section"></div>

        <div class="suggested-destinations">
            <!-- Suggested destinations content -->
        </div>
    </div>
    
<!-- ### START: LEAFLET.JS SCRIPTS ### -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<!-- ### END: LEAFLET.JS SCRIPTS ### -->

<script>
// ALL JAVASCRIPT IS UNCHANGED AND REMAINS THE SAME
let leafletMap;

const districtCoordinates = {
    'Thiruvananthapuram': { lat: 8.5241, lng: 76.9366 },
    'Kollam': { lat: 8.8932, lng: 76.6141 },
    'Pathanamthitta': { lat: 9.2648, lng: 76.7870 },
    'Alappuzha': { lat: 9.4981, lng: 76.3388 },
    'Kottayam': { lat: 9.5916, lng: 76.5222 },
    'Idukki': { lat: 9.8392, lng: 76.9746 },
    'Ernakulam': { lat: 9.9816, lng: 76.2996 },
    'Thrissur': { lat: 10.5276, lng: 76.2144 },
    'Palakkad': { lat: 10.7867, lng: 76.6548 },
    'Malappuram': { lat: 11.0736, lng: 76.0742 },
    'Kozhikode': { lat: 11.2588, lng: 75.7804 },
    'Wayanad': { lat: 11.6854, lng: 76.1320 },
    'Kannur': { lat: 11.8745, lng: 75.3704 },
    'Kasaragod': { lat: 12.5002, lng: 74.9896 }
};

document.getElementById('planTripForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const source = document.getElementById('sourceDistrict').value;
    const destination = document.getElementById('destinationDistrict').value;
    const budget = document.getElementById('budget').value;
    const interest = document.getElementById('interest').value;
    
    if (!source || !destination || !budget || !interest) {
        alert('Please fill out all fields.');
        return;
    }
    if (source === destination) {
        alert('Source and Destination cannot be the same.');
        return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    generateBtn.disabled = true;
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline';

    try {
        const response = await fetch('/api/generate-route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source, destination, budget, interest })
        });
        const data = await response.json();
        const routeSection = document.getElementById('generatedRouteSection');
        if (data.success) {
            renderRoute(data.route);
            routeSection.classList.add('active');
            routeSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            routeSection.innerHTML = `<p style="color: var(--danger-color);">${data.message || 'Could not generate a route.'}</p>`;
            routeSection.classList.add('active');
        }
    } catch (error) {
        console.error('Error fetching route:', error);
        alert('An error occurred while generating the route. Please try again.');
    } finally {
        generateBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
});

function initMapAndRoute(source, destination) {
    if (leafletMap) {
        leafletMap.remove();
    }
    const sourceCoords = districtCoordinates[source];
    const destCoords = districtCoordinates[destination];
    if (!sourceCoords || !destCoords) {
        document.getElementById("map").innerHTML = "<p>Could not find coordinates for the selected districts.</p>";
        console.error("Missing coordinates for:", source, "or", destination);
        return;
    }
    leafletMap = L.map('map').setView([10.8505, 76.2711], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(leafletMap);
    L.Routing.control({
        waypoints: [
            L.latLng(sourceCoords.lat, sourceCoords.lng),
            L.latLng(destCoords.lat, destCoords.lng)
        ],
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        lineOptions: {
            styles: [{ color: 'var(--primary-color)', opacity: 0.8, weight: 6 }]
        }
    }).addTo(leafletMap);
}

function renderRoute(routeData) {
    const routeSection = document.getElementById('generatedRouteSection');
    const stopsHTML = routeData.stops.map(stop => `
        <div class="stop-card">
            <h5>${stop.name}</h5>
            <p>${stop.type}</p>
            <p>Est. Budget: ₹${stop.budget ? stop.budget.toLocaleString() : 'N/A'}</p>
            <span class="status-badge ${stop.safety_class}">${stop.safety_text}</span>
        </div>
    `).join('');
    const alertsHTML = routeData.alerts.length > 0 ? routeData.alerts.map(alert => `
        <div class="weather-alert-card ${alert.severity_class}">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <h5>${alert.type} Alert</h5>
                <p>${alert.description}</p>
                <span>Logged on: ${alert.date}</span>
            </div>
        </div>
    `).join('') : '<p>No recent alerts for the recommended stops.</p>';
    
    routeSection.innerHTML = `
        <div class="route-header">
            <i class="fas fa-check-square"></i> Safe Route Generated
        </div>
        <div class="route-layout">
            <div id="map"></div>
            <div id="route-details">
                <div class="route-card">
                    <h4>Route Summary</h4>
                    <div class="route-summary-details">
                        <p><strong>${routeData.source}</strong> <i class="fas fa-arrow-right"></i> <strong>${routeData.destination}</strong></p>
                        <p>Interest: <strong>${routeData.interest}</strong></p>
                        <span class="status-badge ${routeData.overall_safety_class}">Overall Safety: ${routeData.overall_safety_text}</span>
                    </div>
                </div>
                <div class="route-card">
                    <h4>Recommended Stop on Route</h4>
                    <div class="recommended-stops">
                        ${stopsHTML}
                    </div>
                </div>
                <div class="route-card">
                    <h4>Weather & Disaster Alerts</h4>
                    ${alertsHTML}
                </div>
                <div class="tip-card">
                    <i class="fas fa-info-circle"></i>
                    <p>${routeData.tip}</p>
                </div>
            </div>
        </div>
    `;
    setTimeout(() => {
        initMapAndRoute(routeData.source, routeData.destination);
    }, 100);
}
</script>
</body>
</html>